breaks = c(-Inf,18.5, 23,25,30, Inf),
labels = c(1,0,2,3,4),
right = FALSE
)]
a[, BMI_cat5_new := factor(
BMI_cat5_new,
levels = c("0", "1", "2", "3", "4"),
labels = c("18.5-23", "<18.5", "23-25", "25-30", "≥30")
)]
a1 <- c("KT_date", "pre_PRA_classI_date", "dnDSA_date", "BPAR_date", "GF_date", "death_date", "inf_adm_date"
, "PCP_Date", "CMV_viremia_date", "EBV_viremia_date", "BK_viremia_date", "BK_highviremia_date"
, "malignancy_DATE", "malig_1_FU", "malig_2_FU", "malig_3_FU")
a2 <- c("exam_dt")
a3 <- c("exam_dt")
a4 <- c("DRUG_DT")
a5 <- c("DRUG_DT")
a6 <- c("KT_date", "DRUG_DT")
a7 <- c("exam_dt")
a8 <- c("KT_date", "bx_date")
dt2 <- alist[[2]][, .(studyID, exam_dt)]
# 맨 마지막 행만 남기기
dt2_last <- dt2[order(exam_dt) , .SD[.N], by = studyID]
dt4 <- alist[[4]][, .(study_ID, DRUG_DT)]
# 맨 마지막 행만 남기기
setnames(dt4, "study_ID", "studyID")
dt4_last <- dt4[order(DRUG_DT), .SD[.N], by = studyID]
dt8 <- alist[[8]][, .(studyID, bx_date)]
dt8_last <- dt8[order(bx_date), .SD[.N], by = studyID]
a <- merge(a, dt2_last, by = "studyID", all.x = TRUE)
a <- merge(a, dt4_last, by = "studyID", all.x = TRUE)
a <- merge(a, dt8_last, by = "studyID", all.x = TRUE)
date_cols <- unique(c(a1, a2, a3, a4, a5, a6, a7, a8))
for (col in date_cols) {
a[[col]] <- as.Date(a[[col]])
}
zzz <- apply(a[, .SD, .SDcols = date_cols], 1, max, na.rm = TRUE)
summary(zzz)
min(zzz)
which(zzz == "2005-01-14")
a[7575]
a[, max_date := zzz]
# a col 추가, as.Date로 Date로 바꾸고 이식일에서 뺀 차이 계산
# 이식일로부터 event가 발생한 날까지의 경과 일수를 정수로 반환
for (v in c("death","GF","BPAR","dnDSA","inf_adm","malignancy")) {
date.col <- if (v=="malignancy") "malignancy_DATE" else paste0(v,"_date")
a[, paste0(v,"_day") := as.integer(pmax(pmin(as.Date(get(date.col)), as.Date(max_date), na.rm = T) - as.Date(KT_date), 0))]
}
a[, DGF := as.integer(DGF %in% 1:2)]
a[, DGF_day := ifelse(DGF == 0, as.integer(as.Date(max_date) - as.Date(KT_date)), DGF_HD_days)]
a[, mismatched_HLA := as.integer(totalMM >= 3)]
# age_div col구간나눠서 라벨링x
a[, age_div := cut(age,
breaks = c(0, 40, 60, 200),
labels = c("40 less", "40-59", "60 or more"),
right = FALSE)]
# repeated_KT
a[, repeated_KT := factor(
TPL_N != 1,
labels = c("1st transplant", "2nd+ transplant"))]
# DSA
a[, DSA := as.integer(
rowSums(.SD == 1, na.rm = TRUE) > 0
),
.SDcols = c("pre_CDCXM_B","pre_FXM_B","pre_FXM_T","pre_DSA")
]
a[, DSA := factor(
DSA,
levels = c(0, 1),
labels = c("Negative", "Positive")
)]
# induction을 factor화
a[, induction := factor(
induction,
levels = c(1, 2, 3, 4),
labels = c("none", "basiliximab", "ATG", "others")
)]
# cause of ESRD
a[, cause_of_ESRD := factor(
ifelse(
is.na(org_dis), "Unknown",
ifelse(
org_dis == 1, "DM",
ifelse(org_dis %in% c(3, 5), "GN", "Unknown")
)
),
levels = c("DM","GN","Unknown")
)]
# ABOi중 NA를 not reported로 바꾸기
a[, ABOi_cat := factor(
ifelse(
is.na(ABOi), "not reported",
ifelse(
ABOi == 1, "ABOi",
ifelse(ABOi == 0, "ABOc", "not reprted")
)
),
levels = c("ABOi", "ABOc", "not reported")
)]
# sCr
info.scr <- merge(alist$LAB_SCR, alist$Combine_dataset[, .(studyID, KT_date)], by = "studyID", all.x = TRUE) %>%
.[, sCr_yr := as.integer(as.Date(exam_dt) - as.Date(KT_date))/365.25] %>% .[]
col.scr <- sapply(0:5, function(i){
merge(a[, .(studyID)], info.scr[(sCr_yr >= (i - 1/12) &  (sCr_yr <= (i + 13/12))), mean(scr, na.rm = T), keyby = "studyID"], all.x = T)$V1
})
colnames(col.scr) <- paste0("sCr_", 0:5)
#tac
info.tac <- merge(alist$Tacrolimus_trough_level,
alist$Combine_dataset[, .(studyID, KT_date)],
by = 'studyID', all.x = TRUE) %>%
.[, tac_yr := as.integer(as.Date(exam_dt) - as.Date(KT_date)) / 365.25] %>% .[]
col.tac <- sapply(0:5, function(i){
merge(a[, .(studyID)], info.tac[(tac_yr >= i -(1/12) & (tac_yr <= (i + 13/12))),
mean(value, na.rm = TRUE),
keyby = "studyID"],
all.x = TRUE)$V1
})
colnames(col.tac) <- paste0("tac_", 0:5)
a[, Age50 := as.integer(age >= 50)]
## 수정필요
# GF: graft failure: 이식 실패
# BPAR: Biopsy-Proven Acute Rejection, 조직검사로 확진된 급성 거부반응
# SCR: Serum Creatinine, 혈당 크레아틴 수치, 신장이식 후 신기능 평가할 때 쓰는 지표
varlist <- list(
Base = c(
# recipient
"age", "Age50", "sex", "BMI", "pre_dial_month", "cause_of_ESRD", "DM", "HTN", "repeated_KT",
# donor
"D_age", "D_sex", "D_BMI", "D_HTN", "D_LDDD",
# transplant
"mismatched_HLA", "DSA", "ABOi_cat", "CIT", "WIT", "graft_wt",
# immunosuppression
"desens", "induction",
# BMI categories
"BMI_cat5_new","BMI_cat4_new", "BMI_cat5", "BMI_cat4", "BMI_cat3"
),
Event = c("DGF", "dnDSA", "BPAR", "GF", "inf_adm", "death"),
Day = paste0(c("DGF", "dnDSA", "BPAR", "GF", "inf_adm", "death"), "_day"),
Event_binary = c("CVE"),
Longitudinal = c(paste0("sCr_", 0:5), paste0("tac_", 0:5))
)
out <- cbind(a, col.scr, col.tac)[
BMI >= 10 & BMI <= 50 &
max_date > as.Date(KT_date) &
!is.na(pre_dial_month) &
!is.na(DM) &
!is.na(HTN),
.SD,
.SDcols = c("studyID", setdiff(unlist(varlist), "dnDSA_comp"))
]
# 1. Filter induction: remove 'none' and 'others'
out <- out[induction %in% c("basiliximab", "ATG")]
out[, induction := droplevels(induction)]
# 2. Filter D_LDDD and ABOi: drop ABOi patients among D_LDDD == 1 (Deceased)
out <- out[!(D_LDDD == 1 & ABOi_cat == "ABOi")]
out <- cbind(a, col.scr, col.tac)[
BMI >= 10 & BMI <= 50 &
max_date > as.Date(KT_date) &
!is.na(pre_dial_month) &
!is.na(DM) &
!is.na(HTN),
.SD,
.SDcols = c("studyID", setdiff(unlist(varlist), "dnDSA_comp"))
]
dim(out)
out[induction %in% c("basiliximab", "ATG")] %>% dim
shiny::runApp()
out <- cbind(a, col.scr, col.tac)[
BMI >= 10 & BMI <= 50 &
max_date > as.Date(KT_date) &
!is.na(pre_dial_month) &
!is.na(DM) &
!is.na(HTN),
.SD,
.SDcols = c("studyID", setdiff(unlist(varlist), "dnDSA_comp"))
]
out[induction %in% c("basiliximab", "ATG")]
# 1. Filter induction: remove 'none' and 'others'
out <- out[induction %in% c("basiliximab", "ATG")]
out[, induction := droplevels(induction)]
# 2. Filter D_LDDD and ABOi: drop ABOi patients among D_LDDD == 1 (Deceased)
out <- out[!(D_LDDD == 1 & ABOi_cat == "ABOi")]
dim(out)
out <- cbind(a, col.scr, col.tac)[
BMI >= 10 & BMI <= 50 &
max_date > as.Date(KT_date) &
!is.na(pre_dial_month) &
!is.na(DM) &
!is.na(HTN),
.SD,
.SDcols = c("studyID", setdiff(unlist(varlist), "dnDSA_comp"))
]
dim(out)
out[induction %in% c("basiliximab", "ATG")] %>% dim
out$induction %>% table
out[, .N, keyby = LDDD]
out[, .N, keyby = D_LDDD]
out[!(D_LDDD == 1 & ABOi_cat == "ABOi")][, .N, keyby = D_LDDD]
source("~/ShinyApps/smc-gs/kw1980.lee/Astellas/global.R")
out$D_LDDD %>% is.na %>% table
library(jstable);library(survival);library(ggplot2);library(data.table);library(magrittr)
#setwd("~/ShinyApps/smc-gs/kw1980.lee/Astellas")
source("R/kaplan.R", local=FALSE)
## Read data
board <- pins::board_s3("zarathu", prefix = "pins/smc-gs/kw1980.lee/Astellas")
load_astellas_data <- function(
board = pins::board_s3("zarathu", prefix = "pins/smc-gs/kw1980.lee/Astellas"),
name = "astellas",
cache_path = file.path("app_cache", paste0(name, ".rds")),
refresh = FALSE
) {
if (!refresh && file.exists(cache_path)) {
return(readRDS(cache_path))
}
dir.create(dirname(cache_path), recursive = TRUE, showWarnings = FALSE)
alist <- tryCatch(
pins::pin_read(board, name),
error = function(e) {
if (file.exists(cache_path)) {
warning(
sprintf(
"pins::pin_read(%s) failed; using cached data from %s. Error: %s",
sQuote(name),
sQuote(cache_path),
conditionMessage(e)
),
call. = FALSE
)
return(readRDS(cache_path))
}
stop(
sprintf(
"Failed to load Astellas data from pins (%s) and no cache found at %s.\nOriginal error: %s",
sQuote(name),
sQuote(cache_path),
conditionMessage(e)
),
call. = FALSE
)
}
)
saveRDS(alist, cache_path)
alist
}
alist <- load_astellas_data()
# fl <- list.files(pattern = "xlsx")[-1]
# alist <- parallel::mclapply(fl, \(x){readxl::read_excel(x) %>% data.table})
# names(alist) <- gsub(" ", "", sapply(strsplit(fl, "\\."), `[[`, 2))
# board %>% pins::pin_write(alist, name = "astellas", type = "rds")
a <- alist$Combine_dataset %>%
merge(alist$KT_date_5070_durg_Inf[order(DRUG_DT), .SD[.N], keyby = "studyID"][, .(studyID, LastFUdate = DRUG_DT)], by = "studyID", all.x = TRUE)
# Tacrolimus Trough Level
at <- alist$Tacrolimus_trough_level
# value가 level. exam_dt를 시계열로 보고싶다.date만 있으머ㅕㄴ됨.
# at의 studyid라는 col을 studyID로 변경.
setnames(at, "studyid", "studyID")
# at의 tacro_troughh_level이라는 col을 a에 추가.
# a[at, tacro_trough_level := value, on = "studyID"]
# a$tacro_trough_level
# col이름 변경
setnames(a, c("DRUG0", "DRUG3", "DRUG4"), c("Tacrolimus", "MMF", "Steriod"))
# alist[6]
# alist[[4]]$D_TYPE %>% table
# alist[7] %>% head
# a$studyID %>% head
#D_LDDD 이상한거거
a[D_LDDD == 0, D_LDDD := 3]
# 3인 경우를 1로 나머지 1&2를 0으로
a[, D_LDDD := as.integer(D_LDDD ==3)]
# 18세 이상 환자만 남기기
a <- a[age>=18]
# BMI 3구간
a[, BMI_cat3 := cut(
BMI,
breaks = c(-Inf, 18.5, 25, Inf),
labels = c(1, 0, 2),
right = FALSE
)]
a[, BMI_cat3 := factor(
BMI_cat3,
levels = c("0", "1", "2"),
labels = c("18.5-25", "<18.5", "≥25")
)]
# BMI 4구간
a[, BMI_cat4 := cut(
BMI,
breaks = c(-Inf, 18.5, 25, 30, Inf),
labels = c(1, 0, 2, 3),
right = FALSE
)]
a[, BMI_cat4 := factor(
BMI_cat4,
levels = c("0", "1", "2", "3"),
labels = c("18.5-25", "<18.5", "25-30", "≥30")
)]
# BMI 5구간
a[, BMI_cat5 := cut(
BMI,
breaks = c(-Inf, 18.5, 25, 30, 35, Inf),
labels = c(1, 0, 2, 3, 4),
right = FALSE
)]
a[, BMI_cat5 := factor(
BMI_cat5,
levels = c("0", "1", "2", "3", "4"),
labels = c("18.5-25", "<18.5", "25-30", "30-35", "≥35")
)]
a[, BMI_cat4_new := cut(
BMI,
breaks = c(-Inf, 18.5, 23, 25, Inf),
labels = c(1, 0, 2, 3),
right = FALSE
)]
a[, BMI_cat4_new := factor(
BMI_cat4_new,
levels = c("0", "1", "2", "3"),
labels = c("18.5-23", "<18.5", "23-25", "≥25")
)]
a[, BMI_cat5_new := cut(
BMI,
breaks = c(-Inf,18.5, 23,25,30, Inf),
labels = c(1,0,2,3,4),
right = FALSE
)]
a[, BMI_cat5_new := factor(
BMI_cat5_new,
levels = c("0", "1", "2", "3", "4"),
labels = c("18.5-23", "<18.5", "23-25", "25-30", "≥30")
)]
a1 <- c("KT_date", "pre_PRA_classI_date", "dnDSA_date", "BPAR_date", "GF_date", "death_date", "inf_adm_date"
, "PCP_Date", "CMV_viremia_date", "EBV_viremia_date", "BK_viremia_date", "BK_highviremia_date"
, "malignancy_DATE", "malig_1_FU", "malig_2_FU", "malig_3_FU")
a2 <- c("exam_dt")
a3 <- c("exam_dt")
a4 <- c("DRUG_DT")
a5 <- c("DRUG_DT")
a6 <- c("KT_date", "DRUG_DT")
a7 <- c("exam_dt")
a8 <- c("KT_date", "bx_date")
dt2 <- alist[[2]][, .(studyID, exam_dt)]
# 맨 마지막 행만 남기기
dt2_last <- dt2[order(exam_dt) , .SD[.N], by = studyID]
dt4 <- alist[[4]][, .(study_ID, DRUG_DT)]
# 맨 마지막 행만 남기기
setnames(dt4, "study_ID", "studyID")
dt4_last <- dt4[order(DRUG_DT), .SD[.N], by = studyID]
dt8 <- alist[[8]][, .(studyID, bx_date)]
dt8_last <- dt8[order(bx_date), .SD[.N], by = studyID]
a <- merge(a, dt2_last, by = "studyID", all.x = TRUE)
a <- merge(a, dt4_last, by = "studyID", all.x = TRUE)
a <- merge(a, dt8_last, by = "studyID", all.x = TRUE)
date_cols <- unique(c(a1, a2, a3, a4, a5, a6, a7, a8))
for (col in date_cols) {
a[[col]] <- as.Date(a[[col]])
}
zzz <- apply(a[, .SD, .SDcols = date_cols], 1, max, na.rm = TRUE)
summary(zzz)
min(zzz)
which(zzz == "2005-01-14")
a[7575]
a[, max_date := zzz]
# a col 추가, as.Date로 Date로 바꾸고 이식일에서 뺀 차이 계산
# 이식일로부터 event가 발생한 날까지의 경과 일수를 정수로 반환
for (v in c("death","GF","BPAR","dnDSA","inf_adm","malignancy")) {
date.col <- if (v=="malignancy") "malignancy_DATE" else paste0(v,"_date")
a[, paste0(v,"_day") := as.integer(pmax(pmin(as.Date(get(date.col)), as.Date(max_date), na.rm = T) - as.Date(KT_date), 0))]
}
a[, DGF := as.integer(DGF %in% 1:2)]
a[, DGF_day := ifelse(DGF == 0, as.integer(as.Date(max_date) - as.Date(KT_date)), DGF_HD_days)]
a[, mismatched_HLA := as.integer(totalMM >= 3)]
# age_div col구간나눠서 라벨링x
a[, age_div := cut(age,
breaks = c(0, 40, 60, 200),
labels = c("40 less", "40-59", "60 or more"),
right = FALSE)]
# repeated_KT
a[, repeated_KT := factor(
TPL_N != 1,
labels = c("1st transplant", "2nd+ transplant"))]
# DSA
a[, DSA := as.integer(
rowSums(.SD == 1, na.rm = TRUE) > 0
),
.SDcols = c("pre_CDCXM_B","pre_FXM_B","pre_FXM_T","pre_DSA")
]
a[, DSA := factor(
DSA,
levels = c(0, 1),
labels = c("Negative", "Positive")
)]
# induction을 factor화
a[, induction := factor(
induction,
levels = c(1, 2, 3, 4),
labels = c("none", "basiliximab", "ATG", "others")
)]
# cause of ESRD
a[, cause_of_ESRD := factor(
ifelse(
is.na(org_dis), "Unknown",
ifelse(
org_dis == 1, "DM",
ifelse(org_dis %in% c(3, 5), "GN", "Unknown")
)
),
levels = c("DM","GN","Unknown")
)]
# ABOi중 NA를 not reported로 바꾸기
a[, ABOi_cat := factor(
ifelse(
is.na(ABOi), "not reported",
ifelse(
ABOi == 1, "ABOi",
ifelse(ABOi == 0, "ABOc", "not reprted")
)
),
levels = c("ABOi", "ABOc", "not reported")
)]
# sCr
info.scr <- merge(alist$LAB_SCR, alist$Combine_dataset[, .(studyID, KT_date)], by = "studyID", all.x = TRUE) %>%
.[, sCr_yr := as.integer(as.Date(exam_dt) - as.Date(KT_date))/365.25] %>% .[]
col.scr <- sapply(0:5, function(i){
merge(a[, .(studyID)], info.scr[(sCr_yr >= (i - 1/12) &  (sCr_yr <= (i + 13/12))), mean(scr, na.rm = T), keyby = "studyID"], all.x = T)$V1
})
colnames(col.scr) <- paste0("sCr_", 0:5)
#tac
info.tac <- merge(alist$Tacrolimus_trough_level,
alist$Combine_dataset[, .(studyID, KT_date)],
by = 'studyID', all.x = TRUE) %>%
.[, tac_yr := as.integer(as.Date(exam_dt) - as.Date(KT_date)) / 365.25] %>% .[]
col.tac <- sapply(0:5, function(i){
merge(a[, .(studyID)], info.tac[(tac_yr >= i -(1/12) & (tac_yr <= (i + 13/12))),
mean(value, na.rm = TRUE),
keyby = "studyID"],
all.x = TRUE)$V1
})
colnames(col.tac) <- paste0("tac_", 0:5)
a[, Age50 := as.integer(age >= 50)]
#####################
#apply(a[, .SD, .SDcols = grep("_date|Date", names(a), value = T)], 1, max, na.rm = T) %>% as.Date %>% summary
#zz <- apply(a[, .SD, .SDcols = grep("_date|Date", names(a), value = T)], 1, max, na.rm = T)
#summary(zz)
#min(zz)
#which(zz == "2005-01-08")
#a[7572]
######################
# "studyID", "sex", "age", "age_div", "BMI", "HTN", "DM", "pre_dial_month", "pre_HBsAg", "pre_Anti_HBs", "pre_HBcIgG", "pre_HBcIgM", "HBVDNA", "pre_HCV_ab", "pre_HIV_AgHb",
# "HLA_A1", "HLA_A2", "HLA_B1", "HLA_B2", "HLA_DR1", "HLA_DR2", "HLA_DQ1", "HLA_DQ2", "totalMM",
# "pre_PRA_classI", "pre_PRA_classII", "pre_DSA_YN", "pre_DSA_type", "pre_DSA_MFI_peak","ABO", "ABOi",
# "KT_date",
# "D_LDDD", "D_age", "D_sex", "bwt", "height", "D_bwt", "D_height",
# "induction","Tacrolimus", "tacro_trough_level", "MMF", "Steriod",
# "GF",
# "GF_date", "GF_cause",
# "death", "death_date",
# "BPAR", "BPAR_date", "BPAR_type",
# "CMV_viremia", "CMV_viremia_date", "BK_viremia", "BK_viremia_date", "BK_highviremia", "BK_highviremia_date",
# "CVE", "CVE_1_type", "CVE_1_fatal",
# "malignancy", "malignancy_DATE", "malig_1_type", "malig_1_site", "malig_1_sp", "malig_1_FU", "malig_1_FU_state"
## 수정필요
# GF: graft failure: 이식 실패
# BPAR: Biopsy-Proven Acute Rejection, 조직검사로 확진된 급성 거부반응
# SCR: Serum Creatinine, 혈당 크레아틴 수치, 신장이식 후 신기능 평가할 때 쓰는 지표
varlist <- list(
Base = c(
# recipient
"age", "Age50", "sex", "BMI", "pre_dial_month", "cause_of_ESRD", "DM", "HTN", "repeated_KT",
# donor
"D_age", "D_sex", "D_BMI", "D_HTN", "D_LDDD",
# transplant
"mismatched_HLA", "DSA", "ABOi_cat", "CIT", "WIT", "graft_wt",
# immunosuppression
"desens", "induction",
# BMI categories
"BMI_cat5_new","BMI_cat4_new", "BMI_cat5", "BMI_cat4", "BMI_cat3"
),
Event = c("DGF", "dnDSA", "BPAR", "GF", "inf_adm", "death"),
Day = paste0(c("DGF", "dnDSA", "BPAR", "GF", "inf_adm", "death"), "_day"),
Event_binary = c("CVE"),
Longitudinal = c(paste0("sCr_", 0:5), paste0("tac_", 0:5))
)
#cov.adj <- c("MVR", "TV_repair", "TVR", "MICS", "redoOHS", "age", "DM", "HTN", "COPD", "GFR", "Dyslipidemia", "PreopAF", "LVIDd_ab", "LA_d_ab", "EF", "severeTR", "TR_velocity", "severeMR")
out <- cbind(a, col.scr, col.tac)[
BMI >= 10 & BMI <= 50 &
max_date > as.Date(KT_date) &
!is.na(pre_dial_month) &
!is.na(DM) &
!is.na(HTN),
.SD,
.SDcols = c("studyID", setdiff(unlist(varlist), "dnDSA_comp"))
]
# 1. Filter induction: remove 'none' and 'others'
out <- out[induction %in% c("basiliximab", "ATG")]
out[, induction := droplevels(induction)]
# 2. Filter D_LDDD and ABOi: drop ABOi patients among D_LDDD == 1 (Deceased)
out <- out[!(D_LDDD == 1 & ABOi_cat == "ABOi")]
# receipient 결측 그냥 버리기
# 결측 제거
factor_vars <- names(out)[sapply(out, function(x) length(unique(x))) <= 6]
conti_vars  <- setdiff(names(out), c("studyID",factor_vars))
out[, (factor_vars) := lapply(.SD, factor), .SDcols = factor_vars]
out[, (conti_vars)  := lapply(.SD, as.numeric), .SDcols = conti_vars]
# 3. Drop implausible donor BMI values
out <- out[is.na(D_BMI) | D_BMI <= 300]
out[, (factor_vars) := lapply(.SD, droplevels), .SDcols = factor_vars]
#out$Subject <- factor(out$Subject)
out.label <- jstable::mk.lev(out)
vars01 <- sapply(factor_vars, function(v){identical(levels(out[[v]]), c("0", "1"))})
for (v in names(vars01)[vars01 == T]){
out.label[variable == v, val_label := c("No", "Yes")]
}
out$D_LDDD
out$D_LDDD %>% is.na %>% table
